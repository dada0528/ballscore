<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>羽球計分板 · Green Court</title>
<style>
  /* ========= 主題：經典綠色球場 ========= */
  :root{
    /* 色系 (經典綠 + 柔和黃) */
    --court-green: #3d8b83;   /* 球場綠 */
    --line: #ffffffcc;       /* 球場白線 */
    --text: #213d3a;         /* 深綠文字 */
    --muted: #5e7d7a;        /* 淺綠文字 */
    --accent: #ffc77d;       /* 柔和黃 (強調) */
    --accent-dark: #b5864c;   /* 深黃 */
    --glass: #f0f5f4aa;       /* 磨砂玻璃 (冷白) */
    --danger:#d95d5d;        /* 20+ 紅色 */

    /* 控制列 & 字體大小 */
    --bar:74px;
    --score-size:58px;

    /* 投影 */
    --shadow-lg: 0 16px 40px rgba(0,0,0,.12);
    --shadow-md: 0 10px 24px rgba(0,0,0,.10);
    --shadow-sm: 0 6px 14px rgba(0,0,0,.08);
  }

  /* 背景 */
  html,body{height:100dvh}
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC",sans-serif;
    color:var(--text);
    background: #e8eceb; /* 淺灰綠背景 */
    overflow:hidden;
  }

  main{
    height:100dvh; display:grid; place-items:center;
    padding-bottom:calc(var(--bar) + max(0px, env(safe-area-inset-bottom)));
  }

  /* ========= 舞台（球場容器） ========= */
  .stage{
    position:relative; width:100vw;
    height:calc(100dvh - var(--bar) - max(0px, env(safe-area-inset-bottom)) - 12px);
    max-width:100vw; max-height:calc(100dvh - var(--bar) - max(0px, env(safe-area-inset-bottom)) - 12px);
    border-radius:20px; overflow:hidden;
    border:1px solid rgba(0,0,0,.1);
    background: var(--court-green);
    box-shadow: var(--shadow-lg);
    aspect-ratio:16/9;
  }

  /* ========= 球場繪製 (綠色場地) ========= */
  .court{position:absolute; inset:0; display:grid; grid-template-rows:1fr 1fr}
  .court::before{
    content:""; position:absolute; inset:0;
    background-image: 
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23ffffff' fill-opacity='0.03' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E"),
      radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), rgba(0,0,0,0.1));
    pointer-events:none;
  }
  .half{
    position:relative; display:grid; grid-template-columns:1fr 1fr;
    border-left:2px solid var(--line); border-right:2px solid var(--line);
  }
  .net{
    position:absolute; left:0; right:0; top:50%;
    height: 14px;
    transform: translateY(-50%);
    background: 
      linear-gradient(to bottom, 
        rgba(0,0,0,0.2) 0, rgba(0,0,0,0) 1px, 
        #fff 1px, #fff 4px, 
        #e0e0e0 4px, #e0e0e0 5px, 
        rgba(60,60,60,0.6) 5px
      );
    z-index:3;
    -webkit-mask-image: linear-gradient(to right, transparent, #000 10%, #000 90%, transparent);
    mask-image: linear-gradient(to right, transparent, #000 10%, #000 90%, transparent);
  }
  .court-outer{
    position:absolute; inset:22px; border:3px solid var(--line); border-radius:12px; z-index:0;
    pointer-events:none;
  }
  .court-inner{
    position:absolute; left:22px; right:22px; top:calc(22px + 3px); bottom:calc(22px + 3px);
    border-top:2px solid var(--line); border-bottom:2px solid var(--line);
    pointer-events:none;
  }

  .cell{
    position:relative; cursor:pointer; user-select:none;
    border:1px solid rgba(255,255,255,.2);
    transition: background .2s ease;
  }
  .cell:hover{
    background: rgba(255,255,255,.1);
  }
  .cell.serve{
    background: radial-gradient(circle, rgba(255, 199, 125, 0.7) 0%, rgba(255, 199, 125, 0) 70%) !important;
  }

  .player-label{
    position:absolute; inset:auto 8px 8px auto;
    font-size:12px; color: var(--text);
    background: rgba(255,255,255,.5);
    border:1px solid rgba(255,255,255,.7); border-radius:10px;
    padding:3px 8px; pointer-events:none;
    box-shadow: var(--shadow-sm);
  }
  .half.top .player-label{ inset:8px 8px auto auto }

  .icon-container {
    position: absolute;
    top: 50%; left: 50%;
    display: none; 
    align-items: center; justify-content: center;
    gap: 8px; pointer-events: none; z-index: 5;
    transition: transform 0.3s ease;
  }
  .cell[data-col="left"] .icon-container { transform: translate(-80%, -50%); }
  .cell[data-col="right"] .icon-container { transform: translate(-20%, -50%); }

  .court-logo, .court-shuttle { width: 54px; height: 54px; }
  .court-shuttle { animation: bounce 0.8s infinite alternate; }
  @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-5px); }
  }

  /* <<<<< 修改點：計分板 HUD 預設改為垂直排列 >>>>> */
  .hud{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    display:flex; 
    flex-direction: column; /* 預設垂直排列 */
    align-items:center; 
    gap: 8px; /* 調整垂直間距 */
    padding:12px; border-radius:16px;
    background: var(--glass);
    border: 1px solid rgba(255,255,255,.5);
    box-shadow: var(--shadow-md); z-index:6;
    backdrop-filter: blur(10px) saturate(120%);
  }
  .score-section {
      display: flex; flex-direction: column;
      align-items: center; gap: 5px;
  }
  .team-info {
    display: flex; align-items: center;
    justify-content: center; gap: 8px;
  }
  .score{display:flex; align-items:baseline; gap:8px; font-variant-numeric:tabular-nums}
  .role{opacity:.8; font-size:13px; letter-spacing:.4px; color: var(--muted)}
  .num{
    display:inline-block;
    font-size:var(--score-size); line-height:1; font-weight:900; letter-spacing:.6px;
    color: var(--text);
    text-shadow:0 1px 1px rgba(255,255,255,.5);
    transition: font-size .2s ease;
  }
  .num.danger{ color:var(--danger); }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px;
    background:rgba(255,255,255,.5); border:1px solid rgba(255,255,255,.7); 
    font-size:12px; color: var(--text);
    box-shadow: var(--shadow-sm);
  }
  .badge{
    display:none; padding:6px 10px; border-radius:999px;
    border:1px solid var(--accent-dark); background: #fff5e6cc; color:#8a4f00; 
    font-size:12px; font-weight:700; box-shadow: var(--shadow-sm);
    margin-top: 4px;
  }
  .badge.show{display:inline-flex}

  /* 底部控制列 */
  footer#ctrlBar{
    position:fixed; left:0; right:0; bottom:0; height:var(--bar); z-index:40;
    display:flex; align-items:center; justify-content:center;
    padding:8px max(10px, env(safe-area-inset-right)) calc(8px + max(0px, env(safe-area-inset-bottom))) max(10px, env(safe-area-inset-left));
    pointer-events:none;
  }
  .bar{
    pointer-events:auto;
    max-width:min(980px, 96vw);
    min-height:56px;
    background: linear-gradient(180deg, #f8f5f1, #f2ede8);
    border:1px solid #dcd3c8; border-radius:16px; box-shadow: var(--shadow-md);
    display:flex; gap:10px; align-items:center; padding:8px 10px; overflow:auto;
    -webkit-overflow-scrolling:touch; scrollbar-width:none;
  }
  .bar::-webkit-scrollbar{display:none}

  /* 按鈕 */
  .btn, .seg > button{
    --pad-x:16px; --pad-y:11px;
    display:inline-flex; align-items:center; gap:8px;
    padding:var(--pad-y) var(--pad-x); border-radius:14px;
    font-size:14px; border:1px solid #dcd3c8; color: var(--text);
    background:linear-gradient(180deg,#ffffff,#f6f2ed);
    cursor:pointer; white-space:nowrap;
    transition: all .2s ease;
    box-shadow: 0 2px 0 #ffffff inset, var(--shadow-sm);
  }
  .btn:hover, .seg > button:hover{ background:linear-gradient(180deg,#ffffff,#efe9e2) }
  .btn:active, .seg > button:active{ transform:translateY(1px) }
  .btn.jelly:hover, .seg > button.jelly:hover{ animation: jelly .5s ease-out both }
  @keyframes jelly { 0% {transform:scale(1,1);} 30%{transform:scale(1.06,.94);} 55%{transform:scale(.98,1.02);} 75%{transform:scale(1.02,.99);} 100%{transform:scale(1,1);} }
  .btn.ok{
    background:linear-gradient(180deg, #ffe0b3, var(--accent));
    border-color: var(--accent-dark); color:#5e401a;
    box-shadow: 0 2px 0 #ffffff inset, 0 10px 20px #ffc77d88;
  }
  .seg{
    display:inline-flex; padding:3px; gap:6px; border-radius:14px;
    background:#e6e0d9; border:1px solid #dcd3c8;
    box-shadow: var(--shadow-sm);
  }
  .seg > button{ background:transparent; border:0; color: var(--muted) }
  .seg > button.active{
    background:linear-gradient(180deg, #f8f5f1, #ffffff); 
    color: var(--text); font-weight:700; border-radius:10px; padding:10px 14px;
    box-shadow: inset 0 0 0 1px #ffffff, 0 6px 14px rgba(0,0,0,.08);
  }

  #ctrlBar.hidden .bar{ transform:translateY(120%); opacity:.98; transition:all .25s ease }
  #ctrlBar .bar{ transform:translateY(0); opacity:1; transition:all .25s ease }

  /* 彈窗 */
  .modal{
    position:fixed; inset:0; display:none; place-items:center; z-index:1000;
    background:rgba(61, 139, 131, .35); backdrop-filter: blur(6px);
  }
  .modal.visible{ display:grid }
  .dialog{
    width:min(90vw, 440px);
    background:linear-gradient(180deg,#f8f5f1ee,#fdfcfbe6);
    border:1px solid #dcd3c8; border-radius:20px;
    padding:18px 18px 14px; box-shadow: var(--shadow-lg); text-align:center;
  }
  .dialog h2{ font-size:24px; margin-bottom:6px; color: var(--text) }
  .dialog p{ color: var(--muted); margin:0 0 16px }
  .dialog .actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap }

  /* 開場設定 */
  .setup{ position:fixed; inset:0; display:none; place-items:center; z-index:900;
          background:rgba(61, 139, 131, .35); backdrop-filter: blur(6px); }
  .setup.visible{ display:grid }
  .setup-card{
    width:min(820px, 92vw);
    background:linear-gradient(180deg,#f8f5f1ee,#fdfcfbe6);
    border:1px solid #dcd3c8; border-radius:20px; padding:16px; 
    box-shadow: var(--shadow-lg);
  }
  .setup-head{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px }
  .mini-court{
    position:relative; width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden;
    background: var(--court-green); border:1px solid #dcd3c8;
    display:grid; grid-template-rows:1fr 1fr; margin-bottom:12px;
  }
  .mini-net{ position:absolute; left:0; right:0; top:50%; height:2px; background:linear-gradient(90deg,transparent, var(--muted), transparent) }
  .mini-half{ display:grid; grid-template-columns:1fr 1fr; border-left:2px solid var(--line); border-right:2px solid var(--line) }
  .pos{ position:relative; border:1px dashed rgba(255,255,255,.5); display:flex; align-items:center; justify-content:center; padding:8px }
  .pos label{ position:absolute; top:6px; left:6px; font-size:12px; color: #fff; text-shadow: 0 1px 1px #0005;}
  .pos input{
    width:92%; max-width:260px; padding:10px 12px; border-radius:12px; border:1px solid #dcd3c8;
    background:#fff; color: var(--text); outline:none; box-shadow: var(--shadow-sm);
  }
  .setup-actions{ display:flex; gap:10px; justify-content:flex-end }
  .start-options {
      display: flex; flex-direction: column;
      align-items: center; gap: 10px; margin-top: 15px;
  }
  
  /* 全螢幕模式 */
  .stage.fullscreen-adjust {
    --score-size: 130px; 
  }

</style>
</head>
<body>

<main>
  <section class="stage" id="stage">
    <div class="court">
      <div class="court-outer"></div>
      <div class="court-inner"></div>
      <div class="net"></div>

      <div class="half top" id="halfTop">
        <div class="cell" data-half="top" data-col="left">
          <span class="player-label" id="label-TL"></span>
          <div class="icon-container" id="iconsTopLeft">
            <img src="blue.png" alt="藍隊" class="court-logo">
            <img src="shuttle.png" alt="發球" class="court-shuttle">
          </div>
        </div>
        <div class="cell" data-half="top" data-col="right">
          <span class="player-label" id="label-TR"></span>
          <div class="icon-container" id="iconsTopRight">
            <img src="blue.png" alt="藍隊" class="court-logo">
            <img src="shuttle.png" alt="發球" class="court-shuttle">
          </div>
        </div>
      </div>
      <div class="half bottom" id="halfBottom">
        <div class="cell" data-half="bottom" data-col="left">
          <span class="player-label" id="label-BL"></span>
           <div class="icon-container" id="iconsBottomLeft">
            <img src="red.png" alt="紅隊" class="court-logo">
            <img src="shuttle.png" alt="發球" class="court-shuttle">
          </div>
        </div>
        <div class="cell" data-half="bottom" data-col="right">
          <span class="player-label" id="label-BR"></span>
          <div class="icon-container" id="iconsBottomRight">
            <img src="red.png" alt="紅隊" class="court-logo">
            <img src="shuttle.png" alt="發球" class="court-shuttle">
          </div>
        </div>
      </div>
    </div>
    
    <div class="hud" id="hud">
      <div class="score-section">
        <div class="team-info">
          <span class="role" id="topPlayerNames"></span>
        </div>
        <div class="score" id="scoreTop">
          <span class="num" id="numTop">0</span>
        </div>
      </div>
      <span class="chip">
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3a9 9 0 1 1-9 9a9.01 9.01 0 0 1 9-9m0 2a7 7 0 1 0 7 7a7 7 0 0 0-7-7m.75 3v4.25L16 14l-1.5 1.25L11 12.5V8z"/></svg>
        <span>發球：<strong id="servingSideLabel">下方</strong></span>
      </span>
      <span id="pointBadge" class="badge">局點 / 賽末點</span>
      <div class="score-section">
        <div class="team-info">
          <span class="role" id="bottomPlayerNames"></span>
        </div>
        <div class="score" id="scoreBottom">
          <span class="num" id="numBottom">0</span>
        </div>
      </div>
    </div>
  </section>
</main>

<footer id="ctrlBar">
  <div class="bar">
    <button class="btn ok jelly" id="startBtn">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="m8 5l12 7l-12 7z"/></svg>
      重新開始
    </button>
    
    <div class="seg" id="voiceSeg">
      <button class="jelly active" data-voice="on">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M5 9v6h4l5 5V4L9 9zM19 12a7 7 0 0 0-3-5.74v11.48A7 7 0 0 0 19 12"/></svg>
        語音：開
      </button>
      <button class="jelly" data-voice="off">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="m16.5 12l4.5 4.5l-1.5 1.5l-4.5-4.5l-4.5 4.5L9 16.5l4.5-4.5L9 7.5L10.5 6l4.5 4.5L19.5 6L21 7.5z"/></svg>
        語音：關
      </button>
    </div>

    <button class="btn jelly" id="undoBtn">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12.5 8A6.5 6.5 0 0 1 19 14.5V16h-2v-1.5A4.5 4.5 0 0 0 12.5 10H7.91l2.3 2.3L9.5 14L5 9.5L9.5 5l.71 1.7L7.91 8z"/></svg>
      上一步
    </button>

    <button class="btn jelly" id="fsBtn">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14H5v5h5v-2H7zm12 5v-5h-2v3h-3v2zM7 7h3V5H5v5h2zm12-2h-5v2h3v3h2z"/></svg>
      全螢幕
    </button>
  </div>
</footer>

<div class="modal" id="winModal">
  <div class="dialog" id="winDialog">
    <h2 id="winTitle">比賽結束</h2>
    <p id="winDesc">恭喜！</p>
    <div class="actions">
      <button class="btn ok jelly" id="playAgainBtn">再來一局</button>
      <button class="btn jelly" id="closeModalBtn">關閉</button>
    </div>
  </div>
</div>

<div class="setup" id="setupModal">
  <div class="setup-card">
    <div class="setup-head">
      <strong>比賽模式：</strong>
      <div class="seg" id="modeSeg">
        <button class="jelly active" data-mode="singles">單打</button>
        <button class="jelly" data-mode="doubles">雙打</button>
      </div>
      <span style="color:#437d81;font-size:12px">在對應站位輸入姓名，或「快速開始」用預設名稱。</span>
    </div>

    <div class="mini-court">
      <div class="mini-net"></div>
      <div class="mini-half">
        <div class="pos"><label>上方・左 (藍隊)</label><input id="name-TL" placeholder="藍隊選手1"/></div>
        <div class="pos"><label>上方・右 (藍隊)</label><input id="name-TR" placeholder="藍隊選手2"/></div>
      </div>
      <div class="mini-half">
        <div class="pos"><label>下方・左 (紅隊)</label><input id="name-BL" placeholder="紅隊選手1"/></div>
        <div class="pos"><label>下方・右 (紅隊)</label><input id="name-BR" placeholder="紅隊選手2"/></div>
      </div>
    </div>
    
    <div class="start-options">
      <strong>選擇初始發球方：</strong>
      <div class="seg" id="initServeSeg">
        <button class="jelly active" data-side="top">藍隊 (上方)</button>
        <button class="jelly" data-side="bottom">紅隊 (下方)</button>
      </div>
    </div>

    <div class="setup-actions">
      <button class="btn jelly" id="quickStartBtn">快速開始</button>
      <button class="btn ok jelly" id="applyNamesBtn">開始比賽</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- 狀態 ---------- */
  const state={mode:'singles',scoreTop:0,scoreBottom:0,servingSide:'bottom',history:[],gameOver:false};
  let pendingInitServe='bottom', voiceOn=true;
  let hideTimer=null;

  /* ---------- 名稱（TL/TR/BL/BR）---------- */
  const names={TL:'藍隊選手1', TR:'藍隊選手2', BL:'紅隊選手1', BR:'紅隊選手2'};

  /* ---------- DOM ---------- */
  const stage = document.getElementById('stage');
  const numTop = document.getElementById('numTop');
  const numBottom = document.getElementById('numBottom');
  const servingSideLabel = document.getElementById('servingSideLabel');
  const pointBadge = document.getElementById('pointBadge');
  const ctrlBar = document.getElementById('ctrlBar');
  const fsBtn = document.getElementById('fsBtn');
  const startBtn = document.getElementById('startBtn');
  const undoBtn = document.getElementById('undoBtn');
  const topPlayerNames = document.getElementById('topPlayerNames');
  const bottomPlayerNames = document.getElementById('bottomPlayerNames');

  const iconsTopLeft = document.getElementById('iconsTopLeft');
  const iconsTopRight = document.getElementById('iconsTopRight');
  const iconsBottomLeft = document.getElementById('iconsBottomLeft');
  const iconsBottomRight = document.getElementById('iconsBottomRight');
  
  const cells = [...document.querySelectorAll('.cell')];
  const labels = {
    TL:document.getElementById('label-TL'),
    TR:document.getElementById('label-TR'),
    BL:document.getElementById('label-BL'),
    BR:document.getElementById('label-BR'),
  };

  // Setup
  const setupModal=document.getElementById('setupModal');
  const modeSeg=document.getElementById('modeSeg');
  const nameInputs={
    TL:document.getElementById('name-TL'),
    TR:document.getElementById('name-TR'),
    BL:document.getElementById('name-BL'),
    BR:document.getElementById('name-BR'),
  };
  const applyNamesBtn=document.getElementById('applyNamesBtn');
  const quickStartBtn=document.getElementById('quickStartBtn');
  const initServeSeg = document.getElementById('initServeSeg');

  // Winner
  const winModal=document.getElementById('winModal');
  const dialog=document.getElementById('winDialog');
  const winTitle=document.getElementById('winTitle');
  const winDesc=document.getElementById('winDesc');
  const playAgainBtn=document.getElementById('playAgainBtn');
  const closeModalBtn=document.getElementById('closeModalBtn');

  /* ---------- 規則 ---------- */
  function resolveServeBox(){
    const s = state.servingSide;
    const score = (s === 'top') ? state.scoreTop : state.scoreBottom;
    const even = (score % 2 === 0);

    if (s === 'top') {
      return even ? ['top', 'left'] : ['top', 'right'];
    } else { 
      return even ? ['bottom', 'right'] : ['bottom', 'left'];
    }
  }

  function haveWinner(){
    const A=state.scoreTop, B=state.scoreBottom;
    const max=Math.max(A,B), min=Math.min(A,B);
    if((max>=21 && max-min>=2) || max===30) return A>B?'top':'bottom';
    return null;
  }
  function gamePointMessage(){
    const A=state.scoreTop,B=state.scoreBottom;
    if(A===29 && B===29) return '雙方賽末點';
    if(A>=20 && A-B===1) return '上方局點';
    if(B>=20 && B-A===1) return '下方局點';
    return '';
  }

  /* ---------- UI 更新 ---------- */
  function updateDigitsColor(){
    numTop.classList.toggle('danger', state.scoreTop>=20);
    numBottom.classList.toggle('danger', state.scoreBottom>=20);
  }
  function updateServeTile(){
    cells.forEach(c=>c.classList.remove('serve'));
    const [h,c]=resolveServeBox();
    const tile=document.querySelector(`.cell[data-half="${h}"][data-col="${c}"]`);
    tile?.classList.add('serve');
  }
  
  function updateServingIcons() {
      iconsTopLeft.style.display = 'none';
      iconsTopRight.style.display = 'none';
      iconsBottomLeft.style.display = 'none';
      iconsBottomRight.style.display = 'none';

      const [half, col] = resolveServeBox();
      if (half === 'top' && col === 'left') iconsTopLeft.style.display = 'flex';
      if (half === 'top' && col === 'right') iconsTopRight.style.display = 'flex';
      if (half === 'bottom' && col === 'left') iconsBottomLeft.style.display = 'flex';
      if (half === 'bottom' && col === 'right') iconsBottomRight.style.display = 'flex';
  }

  function updateBadges(){
    const msg=gamePointMessage();
    pointBadge.textContent = msg || '局點 / 賽末點';
    pointBadge.classList.toggle('show', !!msg);
  }
  function refreshNameLabels(){
    labels.TL.textContent=names.TL;
    labels.TR.textContent=names.TR;
    labels.BL.textContent=names.BL;
    labels.BR.textContent=names.BR;
    topPlayerNames.textContent = state.mode === 'doubles' ? `${names.TL} & ${names.TR}` : names.TL;
    bottomPlayerNames.textContent = state.mode === 'doubles' ? `${names.BL} & ${names.BR}` : names.BL;
  }
  function updateAll(){
    numTop.textContent=state.scoreTop;
    numBottom.textContent=state.scoreBottom;
    servingSideLabel.textContent=state.servingSide==='top'?'上方':'下方';
    updateDigitsColor(); 
    updateServeTile(); 
    updateServingIcons(); 
    updateBadges(); 
    refreshNameLabels();
  }

  /* ---------- 語音 ---------- */
  function speakSequence(texts){
    if(!voiceOn) return;
    if(!('speechSynthesis' in window)) return;
    try{
      window.speechSynthesis.cancel();
      const queue = texts.filter(t=>t && t.trim());
      const next = () => {
        if(queue.length===0) return;
        const u = new SpeechSynthesisUtterance(queue.shift());
        u.lang='zh-TW'; u.rate=1; u.pitch=1; u.volume=1;
        u.onend = next;
        window.speechSynthesis.speak(u);
      };
      next();
    }catch(e){}
  }
  function scoreText(lastScorer=null){
    const A=state.scoreTop,B=state.scoreBottom;
    let first=A, second=B;
    if(lastScorer==='top'){ first=A; second=B; }
    if(lastScorer==='bottom'){ first=B; second=A; }
    const gp = gamePointMessage();
    return gp ? `${first} 比 ${second}，${gp}` : `${first} 比 ${second}`;
  }
  
  function currentServingNameAndPos(){
    const [h, c] = resolveServeBox();
    let name = '';
    if (h === 'top' && c === 'left') name = names.TL;
    if (h === 'top' && c === 'right') name = names.TR;
    if (h === 'bottom' && c === 'left') name = names.BL;
    if (h === 'bottom' && c === 'right') name = names.BR;
    
    const halfText = (h === 'top' ? '上方' : '下方');
    
    const score = h === 'top' ? state.scoreTop : state.scoreBottom;
    const sideText = (score % 2 === 0) ? '右邊' : '左邊';
    
    return {name, halfText, sideText};
  }

  function servingText(){
    const {name, halfText, sideText}=currentServingNameAndPos();
    return name ? `${name} ${halfText}${sideText}發球。` : '';
  }

  /* ---------- 記分 ---------- */
  function rotateIfServingSideWon(winner, prevServer){
    if(winner!==prevServer) return;
    if(state.mode==='singles') return;
    if(winner==='top'){ [names.TL, names.TR] = [names.TR, names.TL]; }
    else{ [names.BL, names.BR] = [names.BR, names.BL]; }
  }
  function scorePoint(side){
    if(state.gameOver) return;
    const prevServer = state.servingSide;
    state.history.push({...state, names:{...names}});
    if(side==='top') state.scoreTop++; else state.scoreBottom++;
    state.servingSide = side;
    rotateIfServingSideWon(side, prevServer);

    const w = haveWinner();
    updateAll();

    if(w){
      speakSequence([
        scoreText(side),
        `比賽結束，${w==='top'?'上方':'下方'} 獲勝。最終比分 ${state.scoreTop} 比 ${state.scoreBottom}`
      ]);
      showWinner(w);
      state.gameOver=true;
      return;
    }
    speakSequence([ scoreText(side), servingText() ]);
  }

  document.getElementById('halfTop').addEventListener('click',()=>scorePoint('top'));
  document.getElementById('halfBottom').addEventListener('click',()=>scorePoint('bottom'));

  /* ---------- 控制列 ---------- */
  document.getElementById('initServeSeg').addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    pendingInitServe=btn.dataset.side;
    [...e.currentTarget.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b===btn));
  });

  document.getElementById('voiceSeg').addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    voiceOn = (btn.dataset.voice==='on');
    const group = e.currentTarget;
    [...group.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b===btn));
    if(voiceOn) speakSequence(['語音播報已開啟']); else window.speechSynthesis?.cancel();
  });

  startBtn.addEventListener('click', openSetup);
  undoBtn.addEventListener('click',()=>{
    if(!state.history.length) return;
    const prev=state.history.pop();
    state.mode=prev.mode; state.scoreTop=prev.scoreTop; state.scoreBottom=prev.scoreBottom;
    state.servingSide=prev.servingSide; state.gameOver=prev.gameOver;
    Object.assign(names, prev.names||{});
    updateAll();
    speakSequence([ scoreText(null), servingText() ]);
  });

  /* ---------- 全螢幕 ---------- */
  function enterFS(){
    (document.documentElement.requestFullscreen?.() || document.body.requestFullscreen?.())?.catch(err=>alert('全螢幕失敗：'+err));
  }
  function exitFS(){ document.exitFullscreen?.(); }
  fsBtn.addEventListener('click',()=>{ if(!document.fullscreenElement) enterFS(); else exitFS(); });

  function showBarTemporarily(){
    if(!document.fullscreenElement) return;
    ctrlBar.classList.remove('hidden');
    if(hideTimer) clearTimeout(hideTimer);
    hideTimer=setTimeout(()=> ctrlBar.classList.add('hidden'), 2600);
  }
  
  document.addEventListener('fullscreenchange',()=>{
    const isFullscreen = !!document.fullscreenElement;
    stage.classList.toggle('fullscreen-adjust', isFullscreen);
    if(isFullscreen){
      showBarTemporarily();
    } else {
      ctrlBar.classList.remove('hidden');
      if(hideTimer) clearTimeout(hideTimer);
    }
  });
  ['pointermove','touchstart','click','keydown'].forEach(ev=>{
    document.addEventListener(ev, showBarTemporarily, {passive:true});
  });

  /* ---------- 姓名/模式設定 ---------- */
  function openSetup(){
    syncInputsForMode();
    nameInputs.TL.value = names.TL || '';
    nameInputs.TR.value = names.TR || '';
    nameInputs.BL.value = names.BL || '';
    nameInputs.BR.value = names.BR || '';
    setupModal.classList.add('visible');
  }
  function closeSetup(){ setupModal.classList.remove('visible'); }

  modeSeg.addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    state.mode=btn.dataset.mode;
    [...modeSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b===btn));
    syncInputsForMode();
  });
  function syncInputsForMode(){
    const singles = state.mode==='singles';
    nameInputs.TR.parentElement.style.opacity = singles ? '.45' : '1';
    nameInputs.BR.parentElement.style.opacity = singles ? '.45' : '1';
  }

  function startNewMatch(serving='bottom'){
    state.scoreTop=0; state.scoreBottom=0; state.gameOver=false;
    state.servingSide=serving; state.history=[];
    state.history.push({...state, names:{...names}}); // 儲存初始狀態
    updateAll();
    speakSequence(['比賽開始', servingText() ]);
  }
  function applyNames(useDefaultsIfEmpty){
    const get=(v,d)=> (v && v.trim()) ? v.trim() : d;
    if(state.mode==='singles'){
      const top = get(nameInputs.TL.value, useDefaultsIfEmpty?'藍隊選手':'') || '藍隊選手';
      const bottom = get(nameInputs.BL.value, useDefaultsIfEmpty?'紅隊選手':'') || '紅隊選手';
      names.TL = top; names.TR = '';
      names.BL = bottom; names.BR = '';
    }else{
      names.TL = get(nameInputs.TL.value, useDefaultsIfEmpty?'藍隊選手1':'') || '藍隊選手1';
      names.TR = get(nameInputs.TR.value, useDefaultsIfEmpty?'藍隊選手2':'') || '';
      names.BL = get(nameInputs.BL.value, useDefaultsIfEmpty?'紅隊選手1':'') || '紅隊選手1';
      names.BR = get(nameInputs.BR.value, useDefaultsIfEmpty?'紅隊選手2':'') || '';
    }
    
    if (state.mode === 'doubles' && (!names.TL || !names.BL)) {
      alert('雙打模式至少需輸入兩隊的主要選手名稱！');
      return;
    }
    
    closeSetup();
    startNewMatch(pendingInitServe);
  }
  document.getElementById('applyNamesBtn').addEventListener('click',()=>applyNames(true));
  document.getElementById('quickStartBtn').addEventListener('click',()=>{
    if(state.mode==='singles'){
      names.TL='藍隊選手'; names.TR='';
      names.BL='紅隊選手'; names.BR='';
    }else{
      names.TL='藍隊選手1'; names.TR='藍隊選手2';
      names.BL='紅隊選手1'; names.BR='紅隊選手2';
    }
    closeSetup();
    startNewMatch(pendingInitServe);
  });

  /* ---------- 贏家彈窗 ---------- */
  function showWinner(winner){
    winTitle.textContent='比賽結束';
    winDesc.textContent=(winner==='top'?'藍隊':'紅隊')+` 獲勝！最終比分：${state.scoreTop} : ${state.scoreBottom}`;
    winModal.classList.add('visible');
    setTimeout(()=>playAgainBtn.focus(),0);
  }
  function hideModal(){ winModal.classList.remove('visible'); }
  playAgainBtn.addEventListener('click',()=>{ hideModal(); openSetup(); });
  closeModalBtn.addEventListener('click', hideModal);
  winModal.addEventListener('click',e=>{ if(!dialog.contains(e.target)) hideModal(); });
  dialog.addEventListener('click',e=> e.stopPropagation());
  document.addEventListener('keydown',e=>{ if(e.key==='Escape' && winModal.classList.contains('visible')) hideModal(); });

  /* ---------- 初始化 ---------- */
  document.addEventListener('DOMContentLoaded', () => {
    openSetup();
  });
})();
</script>
</body>
</html>